<!DOCTYPE html>
<html lang="he" dir="rtl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GovDoc AI - Analyst Workbench</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;600&family=Fira+Code:wght@400;500&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <style>
      :root {
        --bg-dark: #1e1e24;
        --bg-panel: #25252f;
        --bg-tool: #2e2e3a;
        --border: #3a3a4a;
        --accent: #007bff;
        --accent-hover: #0069d9;
        --text-main: #e0e0e0;
        --text-muted: #a0a0b0;
        --success: #28a745;
        --warning: #ffc107;
        --danger: #dc3545;
        --highlight-ocr: rgba(255, 255, 0, 0.15);
        --highlight-extract: rgba(0, 123, 255, 0.15);
        --highlight-pii: rgba(255, 193, 7, 0.2);
        --redacted: #000;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Heebo", sans-serif;
        background-color: var(--bg-dark);
        color: var(--text-main);
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      /* Top Bar */
      .top-bar {
        height: 50px;
        background: var(--bg-panel);
        border-bottom: 1px solid var(--border);
        display: flex;
        align-items: center;
        padding: 0 1rem;
        justify-content: space-between;
      }

      .logo {
        font-weight: 600;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .logo i {
        color: var(--accent);
      }

      .session-info {
        font-size: 0.85rem;
        color: var(--text-muted);
        font-family: "Fira Code", monospace;
      }

      /* Main Workspace */
      .workspace {
        display: flex;
        flex: 1;
        height: calc(100vh - 50px);
      }

      /* Left Toolbar */
      .toolbar {
        width: 240px;
        background: var(--bg-panel);
        border-left: 1px solid var(--border);
        display: flex;
        flex-direction: column;
        padding: 1rem;
        gap: 1rem;
        overflow-y: auto;
      }

      .tool-category {
        font-size: 0.75rem;
        text-transform: uppercase;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .tool-btn {
        display: flex;
        align-items: center;
        gap: 0.8rem;
        width: 100%;
        padding: 0.8rem 1rem;
        background: var(--bg-tool);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text-main);
        cursor: pointer;
        transition: all 0.2s;
        margin-bottom: 0.5rem;
        text-align: right;
        position: relative;
      }

      .tool-btn:hover:not(:disabled) {
        background: #393948;
        border-color: #555;
      }

      .tool-btn.active {
        background: rgba(0, 123, 255, 0.15);
        border-color: var(--accent);
        color: var(--accent);
      }

      .tool-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        background: rgba(0, 0, 0, 0.2);
      }

      .tool-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #555;
        margin-right: auto;
      }

      .tool-btn.completed .tool-status {
        background: var(--success);
        box-shadow: 0 0 5px var(--success);
      }
      .tool-btn.processing .tool-status {
        background: var(--warning);
        animation: pulse 1s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      /* Center Canvas */
      .canvas-area {
        flex: 1;
        background: #15151a;
        position: relative;
        overflow: auto;
        display: flex;
        justify-content: center;
        padding: 2rem;
        /* Grid Pattern */
        background-image: radial-gradient(#2a2a35 1px, transparent 1px);
        background-size: 20px 20px;
      }

      .document-wrapper {
        position: relative;
        box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        transition: transform 0.3s;
      }

      /* Overlays */
      .overlay-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none; /* Let clicks pass unless strictly needed */
        overflow: hidden;
        display: none; /* Hidden by default */
      }

      .active-layer {
        display: block;
      }

      .overlay-box {
        position: absolute;
        border: 2px dashed rgba(255, 255, 0, 0.5);
        background: var(--highlight-ocr);
        cursor: pointer;
        pointer-events: auto;
        transition: all 0.2s;
        border-radius: 2px;
      }

      .overlay-box:hover {
        border-color: #fff;
        background: rgba(255, 255, 0, 0.25);
        z-index: 10;
      }

      .overlay-box.pii-detected {
        border-color: var(--warning);
        background: var(--highlight-pii);
      }

      .overlay-box.pii-redacted {
        background: var(--redacted);
        border-color: var(--redacted);
      }

      .overlay-box.extracted {
        border-color: var(--accent);
        background: var(--highlight-extract);
        border-style: solid;
      }

      /* Right Panel (Inspector) */
      .inspector {
        width: 340px;
        background: var(--bg-panel);
        border-right: 1px solid var(--border);
        display: flex;
        flex-direction: column;
      }

      .panel-header {
        padding: 1rem;
        border-bottom: 1px solid var(--border);
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .panel-content {
        flex: 1;
        overflow-y: auto;
        padding: 1rem;
      }

      /* Property Grid */
      .prop-group {
        margin-bottom: 1.5rem;
      }
      .prop-label {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-bottom: 0.5rem;
        display: block;
      }
      .prop-value {
        background: var(--bg-tool);
        border: 1px solid var(--border);
        padding: 0.5rem;
        border-radius: 4px;
        font-family: "Fira Code", monospace;
        font-size: 0.85rem;
        color: var(--text-main);
        width: 100%;
      }

      /* AI Insights Panel Styles */
      .insight-card {
        background: rgba(0, 123, 255, 0.1);
        border: 1px solid rgba(0, 123, 255, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }

      .insight-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--accent);
      }

      .insight-body {
        font-size: 0.9rem;
        color: var(--text-muted);
        line-height: 1.5;
      }

      .action-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.5rem;
        margin-top: 1rem;
      }

      .action-btn {
        padding: 0.6rem;
        background: var(--bg-tool);
        border: 1px solid var(--border);
        color: var(--text-main);
        border-radius: 6px;
        cursor: pointer;
        text-align: center;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        font-size: 0.85rem;
      }

      .action-btn:hover {
        background: #393948;
      }
      .action-btn.primary {
        background: var(--accent);
        border-color: var(--accent);
        color: white;
      }
      .action-btn.primary:hover {
        background: var(--accent-hover);
      }

      /* Toast */
      .toast-container {
        position: fixed;
        bottom: 20px;
        left: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 1000;
      }

      .toast {
        background: #333;
        color: #fff;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease-out;
        font-size: 0.9rem;
      }

      @keyframes slideIn {
        from {
          transform: translateX(-20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div class="top-bar">
      <div class="logo">
        <i class="fas fa-microscope"></i>
        GovDoc Analyst Workbench
      </div>
      <div class="session-info">
        <button
          onclick="resetSession()"
          style="
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 1rem;
          "
        >
          <i class="fas fa-redo"></i> Reset
        </button>
        SESSION: <span style="color: var(--accent)">DEV-MANUAL-02</span> |
        STATUS: <span style="color: var(--success)">ONLINE</span>
      </div>
    </div>

    <div class="workspace">
      <!-- Right Inspector -->
      <div class="inspector">
        <div class="panel-header">
          <span>Inspector / Insights</span>
          <i class="fas fa-sliders-h" style="color: var(--text-muted)"></i>
        </div>
        <div class="panel-content" id="inspector-content">
          <div
            style="
              text-align: center;
              color: var(--text-muted);
              margin-top: 2rem;
            "
          >
            <i
              class="fas fa-robot"
              style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5"
            ></i>
            <p>Load a document and run tools to see data.</p>
          </div>
        </div>
      </div>

      <!-- Center Canvas -->
      <div class="canvas-area" id="canvas-area">
        <div
          class="empty-state"
          id="empty-msg"
          style="
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
          "
        >
          <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.2">
            <i class="fas fa-file-upload"></i>
          </div>
          <h2>Load Document</h2>
          <p>Drag & Drop Government Form or click below</p>
          <button
            onclick="triggerUpload()"
            style="
              margin-top: 1rem;
              padding: 0.8rem 2rem;
              background: var(--accent);
              color: white;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              font-weight: 500;
            "
          >
            <i class="fas fa-folder-open"></i> Import Form 101 Sample
          </button>
        </div>

        <div class="document-wrapper" id="doc-wrapper" style="display: none">
          <!-- Visual Document Representation -->
          <div
            id="doc-visual"
            style="
              width: 600px;
              height: 850px;
              background: white;
              color: black;
              padding: 40px;
              box-sizing: border-box;
              font-family: 'Times New Roman', serif;
              position: relative;
            "
          >
            <div
              id="target-header"
              style="
                text-align: center;
                border-bottom: 2px solid #000;
                padding-bottom: 20px;
                margin-bottom: 30px;
              "
            >
              <h2>מדינת ישראל - רשות המסים</h2>
              <h1>טופס 101 - כרטיס עובד</h1>
              <p>לשנת המס 2024</p>
            </div>

            <div id="target-form-fields">
              <div style="display: flex; gap: 20px; margin-bottom: 20px">
                <div style="flex: 1">
                  <strong>שם משפחה:</strong>
                  <div
                    style="
                      border-bottom: 1px dotted #000;
                      height: 25px;
                      font-family: 'Courier New', Courier, monospace;
                      font-size: 1.2rem;
                    "
                  >
                    <span id="target-lastname-val">כהן</span>
                  </div>
                </div>
                <div style="flex: 1">
                  <strong>שם פרטי:</strong>
                  <div
                    style="
                      border-bottom: 1px dotted #000;
                      height: 25px;
                      font-family: 'Courier New', Courier, monospace;
                      font-size: 1.2rem;
                    "
                  >
                    <span id="target-firstname-val">ישראל</span>
                  </div>
                </div>
              </div>

              <div style="margin-bottom: 20px">
                <strong>מספר זהות:</strong>
                <div
                  style="
                    border-bottom: 1px dotted #000;
                    height: 25px;
                    font-family: 'Courier New', Courier, monospace;
                    font-size: 1.2rem;
                    letter-spacing: 5px;
                  "
                >
                  <span id="target-id-val">012345678</span>
                </div>
              </div>

              <div style="margin-bottom: 20px">
                <strong>כתובת מגורים / Address:</strong>
                <div
                  style="
                    border-bottom: 1px dotted #000;
                    height: 25px;
                    font-family: 'Courier New', Courier, monospace;
                    font-size: 1.2rem;
                  "
                >
                  <span id="target-address-val"
                    >רחוב העצמאות 50, פתח תקווה</span
                  >
                </div>
              </div>

              <div style="margin-bottom: 20px">
                <strong>תאריך לידה:</strong>
                <div
                  style="
                    border-bottom: 1px dotted #000;
                    height: 25px;
                    font-family: 'Courier New', Courier, monospace;
                    font-size: 1.2rem;
                  "
                >
                  <span id="target-dob-val">15/05/1985</span>
                </div>
              </div>
            </div>

            <div
              id="target-employer"
              style="margin-top: 50px; border: 1px solid #000; padding: 20px"
            >
              <h4>פרטי מעסיק</h4>
              <p>שם המעסיק: חברת טכנולוגיות בע"מ</p>
              <p>תיק ניכויים: 987654321</p>
            </div>
          </div>

          <!-- Interactive Layers -->
          <div class="overlay-layer" id="layer-ocr"></div>
          <div class="overlay-layer" id="layer-structure"></div>
          <div class="overlay-layer" id="layer-entities"></div>
          <div class="overlay-layer" id="layer-pii"></div>
        </div>
      </div>

      <!-- Left Toolbar -->
      <div class="toolbar">
        <div class="tool-category">Pipeline Controls</div>

        <button class="tool-btn" id="btn-upload" disabled>
          <div class="tool-status"></div>
          <span>1. Ingest</span>
          <i
            class="fas fa-check"
            style="margin-right: auto; opacity: 0"
            id="icon-upload"
          ></i>
        </button>

        <button class="tool-btn" id="btn-ocr" onclick="runOCR()" disabled>
          <div class="tool-status"></div>
          <span>2. Text Recog (OCR)</span>
          <i class="fas fa-font"></i>
        </button>

        <button
          class="tool-btn"
          id="btn-structure"
          onclick="runStructure()"
          disabled
        >
          <div class="tool-status"></div>
          <span>3. Layout Analysis</span>
          <i class="fas fa-border-style"></i>
        </button>

        <button
          class="tool-btn"
          id="btn-extract"
          onclick="runExtraction()"
          disabled
        >
          <div class="tool-status"></div>
          <span>4. Extract Entities</span>
          <i class="fas fa-database"></i>
        </button>

        <button class="tool-btn" id="btn-pii" onclick="runPII()" disabled>
          <div class="tool-status"></div>
          <span>5. Detect PII</span>
          <i class="fas fa-user-shield"></i>
        </button>

        <div
          style="border-top: 1px solid var(--border); margin: 0.5rem 0"
        ></div>

        <button
          class="tool-btn"
          id="btn-insights"
          onclick="runAIInsights()"
          style="border-color: var(--accent)"
          disabled
        >
          <div class="tool-status" style="background: var(--accent)"></div>
          <span style="color: var(--accent); font-weight: 600"
            >6. Get AI Insights</span
          >
          <i class="fas fa-magic" style="color: var(--accent)"></i>
        </button>

        <div
          style="
            margin-top: auto;
            border-top: 1px solid var(--border);
            padding-top: 1rem;
          "
        >
          <div class="tool-category">Actions</div>
          <button
            class="tool-btn"
            onclick="redactAll()"
            id="btn-redact"
            disabled
            style="color: var(--danger); border-color: rgba(220, 53, 69, 0.3)"
          >
            <span>Redact All</span>
            <i class="fas fa-eraser"></i>
          </button>
          <button
            class="tool-btn"
            onclick="exportData()"
            id="btn-export"
            disabled
            style="color: var(--success); border-color: rgba(40, 167, 69, 0.3)"
          >
            <span>Export JSON</span>
            <i class="fas fa-download"></i>
          </button>
        </div>
      </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script>
      // State Management
      let appState = {
        step: 0, // 0:Init, 1:Loaded, 2:OCR, 3:Struct, 4:Extract, 5:PII, 6:Insights
        redacted: false,
      };

      const steps = [
        "btn-upload",
        "btn-ocr",
        "btn-structure",
        "btn-extract",
        "btn-pii",
        "btn-insights",
      ];

      function updateState(newStep) {
        appState.step = Math.max(appState.step, newStep);

        // Enable next button based on logic
        // Logic: Button N is enabled if Step >= N-1
        document.getElementById("btn-ocr").disabled = appState.step < 1;
        document.getElementById("btn-structure").disabled = appState.step < 2;
        document.getElementById("btn-extract").disabled = appState.step < 2; // Can skip structure
        document.getElementById("btn-pii").disabled = appState.step < 4;
        document.getElementById("btn-insights").disabled = appState.step < 4; // Insights needs data

        document.getElementById("btn-redact").disabled = appState.step < 5;
        document.getElementById("btn-export").disabled = appState.step < 4;

        // Visual marking
        steps.forEach((id, idx) => {
          const btn = document.getElementById(id);
          if (idx + 1 < appState.step) {
            btn.classList.add("completed");
          }
        });
      }

      function resetSession() {
        location.reload();
      }

      function showToast(msg, type = "info") {
        const container = document.getElementById("toast-container");
        const toast = document.createElement("div");
        toast.className = "toast";
        toast.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`;
        if (type === "success")
          toast.style.borderLeft = "4px solid var(--success)";
        if (type === "error")
          toast.style.borderLeft = "4px solid var(--danger)";
        if (type === "warning")
          toast.style.borderLeft = "4px solid var(--warning)";

        container.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
      }

      function setProcessing(btnId, isProcessing) {
        const btn = document.getElementById(btnId);
        if (isProcessing) {
          btn.classList.add("processing");
          btn.disabled = true;
          const originalText = btn.querySelector("span").innerText;
          btn.dataset.originalText = originalText;
          btn.querySelector("span").innerText = "Processing...";
        } else {
          btn.classList.remove("processing");
          btn.classList.add("completed");
          // Don't disable, allow re-click to toggle view
          btn.disabled = false;
          if (btn.dataset.originalText)
            btn.querySelector("span").innerText = btn.dataset.originalText;
        }
      }

      function clearLayers() {
        document
          .querySelectorAll(".overlay-layer")
          .forEach((l) => l.classList.remove("active-layer"));
      }

      // --- DYNAMIC POSITIONING HELPER ---
      function getCoords(targetId, padding = 2) {
        const target = document.getElementById(targetId);
        const container = document.getElementById("doc-visual");
        if (!target || !container) return null;

        const tRect = target.getBoundingClientRect();
        const cRect = container.getBoundingClientRect();

        // Calculate relative to the container, taking scrolling into account if needed,
        // but for this layout, relative BBox delta is best.
        // Also account for scroll position of the canvas-area if needed, but here relative to visual wrapper is safest

        // RTL check: if RTL, right is calculated from the right edge
        // But getBoundingClientRect returns standard left/top viewport coords

        return {
          top: tRect.top - cRect.top - padding,
          left: tRect.left - cRect.left - padding,
          width: tRect.width + padding * 2,
          height: tRect.height + padding * 2,
        };
      }

      function createBoxFromId(layer, targetId, text, type, isValue = false) {
        const coords = getCoords(targetId);
        if (!coords) return;

        const div = document.createElement("div");
        div.className = "overlay-box";
        div.style.top = coords.top + "px";
        div.style.left = coords.left + "px"; // Using left for positioning now
        div.style.width = coords.width + "px";
        div.style.height = coords.height + "px";
        if (isValue) div.style.borderStyle = "solid";
        layer.appendChild(div);
      }

      // 1. Upload
      function triggerUpload() {
        const btnId = "btn-upload";
        document.getElementById(btnId).classList.add("processing");

        setTimeout(() => {
          document.getElementById("empty-msg").style.display = "none";
          document.getElementById("doc-wrapper").style.display = "block";
          document.getElementById(btnId).classList.remove("processing");
          document.getElementById(btnId).classList.add("completed");
          document.getElementById("icon-upload").style.opacity = 1;

          showToast("Document Loaded", "success");
          updateState(1);
        }, 800);
      }

      // 2. OCR
      function runOCR() {
        setProcessing("btn-ocr", true);
        showToast("Running Tesseract Engine...");

        setTimeout(() => {
          setProcessing("btn-ocr", false);
          clearLayers();
          const layer = document.getElementById("layer-ocr");
          layer.classList.add("active-layer");
          layer.innerHTML = "";

          // Track dynamic elements
          createBoxFromId(layer, "target-lastname-val", "כהן", "ocr", true);
          createBoxFromId(layer, "target-firstname-val", "ישראל", "ocr", true);
          createBoxFromId(layer, "target-id-val", "012345678", "ocr", true);
          createBoxFromId(layer, "target-address-val", "ADDRESS", "ocr", true);
          createBoxFromId(layer, "target-dob-val", "DOB", "ocr", true);

          updateState(2);
          showToast("Text Recognition Complete", "success");
        }, 1000);
      }

      // 3. Structure
      function runStructure() {
        setProcessing("btn-structure", true);
        setTimeout(() => {
          setProcessing("btn-structure", false);
          clearLayers();
          const layer = document.getElementById("layer-structure");
          layer.classList.add("active-layer");
          layer.innerHTML = "";

          // Headers
          const hCoords = getCoords("target-header", 10);
          createZoneBox(layer, hCoords, "HEADER", "#bd93f9");

          // Body
          const bCoords = getCoords("target-form-fields", 10);
          createZoneBox(layer, bCoords, "FORM_FIELDS", "#ff79c6");

          // Employer
          const eCoords = getCoords("target-employer", 10);
          createZoneBox(layer, eCoords, "EMPLOYER_DATA", "#8be9fd");

          updateState(3);
        }, 800);
      }

      function createZoneBox(layer, coords, label, color) {
        const div = document.createElement("div");
        div.className = "overlay-box";
        div.style.top = coords.top + "px";
        div.style.left = coords.left + "px";
        div.style.width = coords.width + "px";
        div.style.height = coords.height + "px";
        div.style.borderColor = color;
        div.innerHTML = `<span style="background:${color}; color:black; font-size:0.6rem; padding:2px; font-weight:bold;">${label}</span>`;
        layer.appendChild(div);
      }

      // 4. Extract
      function runExtraction() {
        setProcessing("btn-extract", true);
        setTimeout(() => {
          setProcessing("btn-extract", false);
          clearLayers();
          const layer = document.getElementById("layer-entities");
          layer.classList.add("active-layer");
          layer.innerHTML = "";

          // Extract Entities
          [
            "target-lastname-val",
            "target-firstname-val",
            "target-id-val",
            "target-address-val",
          ].forEach((id) => {
            const coords = getCoords(id, 4);
            const div = document.createElement("div");
            div.className = "overlay-box extracted";
            div.style.top = coords.top + "px";
            div.style.left = coords.left + "px";
            div.style.width = coords.width + "px";
            div.style.height = coords.height + "px";
            layer.appendChild(div);
          });

          updateState(4);

          // Update Inspector
          document.getElementById("inspector-content").innerHTML = `
                    <h3 style="color:var(--accent); margin-bottom:1rem;">Extracted Entities</h3>
                    <div class="prop-group">
                        <label class="prop-label">Full Name</label>
                        <input class="prop-value" value="ישראל כהן">
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">ID Number</label>
                        <input class="prop-value" value="012345678">
                    </div>
                    <div class="prop-group">
                        <label class="prop-label">Address</label>
                        <textarea class="prop-value" rows="2">רחוב העצמאות 50, פתח תקווה</textarea>
                    </div>
                `;
        }, 1000);
      }

      // 5. PII
      function runPII() {
        setProcessing("btn-pii", true);
        setTimeout(() => {
          setProcessing("btn-pii", false);
          clearLayers();
          const layer = document.getElementById("layer-pii");
          layer.classList.add("active-layer");
          layer.innerHTML = "";

          // PII detection on ID and Address
          createPIIBox(layer, "target-id-val");
          createPIIBox(layer, "target-address-val");

          updateState(5);
          showToast("Sensitive Data Detected", "warning");
        }, 800);
      }

      function createPIIBox(layer, targetId) {
        const coords = getCoords(targetId, 4);
        const div = document.createElement("div");
        div.className = "overlay-box pii-detected";
        div.style.top = coords.top + "px";
        div.style.left = coords.left + "px";
        div.style.width = coords.width + "px";
        div.style.height = coords.height + "px";
        layer.appendChild(div);
      }

      // 6. AI Insights (NEW)
      function runAIInsights() {
        setProcessing("btn-insights", true);

        setTimeout(() => {
          setProcessing("btn-insights", false);

          // Open visual panel
          document.getElementById("inspector-content").innerHTML = `
                    <h3 style="color:var(--accent); margin-bottom:1rem;"><i class="fas fa-brain"></i> AI Analysis</h3>
                    
                    <div class="insight-card">
                        <div class="insight-header">
                            <i class="fas fa-check-circle" style="color:var(--success)"></i> Valid Employee
                        </div>
                        <div class="insight-body">
                            Document matches <strong>Form 101 (2024)</strong> template.<br>
                            All mandatory fields present. ID checksum valid.
                        </div>
                    </div>

                    <div class="insight-card" style="border-color: rgba(255, 193, 7, 0.3); background: rgba(255, 193, 7, 0.05);">
                        <div class="insight-header" style="color: var(--warning)">
                            <i class="fas fa-exclamation-triangle"></i> Missing Contact
                        </div>
                        <div class="insight-body">
                            No email address or phone number detected in optional fields.
                        </div>
                    </div>

                    <h4 style="margin-top:1.5rem; margin-bottom:0.5rem; font-size:0.8rem; color:var(--text-muted); text-transform:uppercase;">Suggested Automations</h4>
                    <div class="action-grid">
                        <button class="action-btn primary" onclick="triggerAutomation('approve')">
                            <i class="fas fa-paper-plane"></i> Approve & Verify
                        </button>
                        <button class="action-btn" onclick="triggerAutomation('request_info')">
                            <i class="fas fa-envelope"></i> Request Email Address
                        </button>
                        <button class="action-btn" onclick="triggerAutomation('erp')">
                            <i class="fas fa-database"></i> Sync to SAP/ERP
                        </button>
                    </div>
                `;

          updateState(6);
          showToast("AI Insights Generated", "success");
        }, 1200);
      }

      // Automation Action (NEW)
      function triggerAutomation(action) {
        showToast("Triggering Automation Workflow...", "info");

        setTimeout(() => {
          if (action === "approve") {
            showToast(
              "Success: Employee verified and status updated to ACTIVE",
              "success"
            );
          } else if (action === "request_info") {
            showToast(
              "Email sent to manager requesting missing details",
              "success"
            );
          } else if (action === "erp") {
            showToast(
              "Data packet sent to SAP connector (Status: 200 OK)",
              "success"
            );
          }
        }, 1500);
      }

      function redactAll() {
        document
          .querySelectorAll(".pii-detected")
          .forEach((el) => el.classList.add("pii-redacted"));
        showToast("All PII Redacted", "success");
      }

      function exportData() {
        const data = { status: "exported", timestamp: Date.now() };
        const blob = new Blob([JSON.stringify(data)], {
          type: "application/json",
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "export.json";
        a.click();
        showToast("JSON Exported", "success");
      }
    </script>
  </body>
</html>
